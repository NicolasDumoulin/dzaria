<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <title>4 à 2</title>
        <link rel="stylesheet" href="jquery-ui-1.10.2/themes/base/jquery-ui.css" />
        <script type="text/javascript" src="jquery-1.9.1.min.js"></script>
        <script type="text/javascript" src="jquery-ui-1.10.2/ui/minified/jquery-ui.min.js"></script>
        <style media="screen">
            body {
                margin: 0;
                padding: 0;
                text-align: center;
            }
            h1 {
                font-weight: 400;
                height: 5%;
            }
            #board { border-collapse: collapse; height:90%;}
            #board, #board td { border:medium solid black; }
            #board td { width:150px; height:150px; }
            .board-dice { width:140px; height: 140px;}

	    #player0, #board, #player1 { float:left; margin-left:50px;margin-right:50px; }
            
            .button-primary.ui-state-default, .button-primary.ui-widget-content .button-primary.ui-state-default, .button-primary.ui-widget-header .button-primary.ui-state-default { border: 1px solid #407998; background: #004c75 50% 50% repeat-x; font-weight: normal; color: #ffffff; }
            .button-primary.ui-state-default a, .button-primary.ui-state-default a:link, .button-primary.ui-state-default a:visited { color: #ffffff; text-decoration: none; }
            .button-primary.ui-state-hover, .button-primary.ui-widget-content .button-primary.ui-state-hover, .button-primary.ui-widget-header .button-primary.ui-state-hover, .button-primary.ui-state-focus, .button-primary.ui-widget-content .button-primary.ui-state-focus, .button-primary.ui-widget-header .button-primary.ui-state-focus { border: 1px solid #407998; background: #407998 50% 50% repeat-x; font-weight: normal; color: #ffffff; }
            .button-primary.ui-state-hover a, .button-primary.ui-state-hover a:hover { color: #ffffff; text-decoration: none; }
            .button-primary.ui-state-active, .button-primary.ui-widget-content .button-primary.ui-state-active, .button-primary.ui-widget-header .button-primary.ui-state-active { border: 1px solid #004c75; background: #407998 50% 50% repeat-x; font-weight: normal; color: #ffffff; }
            .button-primary.ui-state-active a, .button-primary.ui-state-active a:link, .button-primary.ui-state-active a:visited { color: #ffffff; text-decoration: none; }
            .button-primary.ui-widget :active { outline: none; }

            .button-secondary.ui-state-default, .button-secondary.ui-widget-content .button-secondary.ui-state-default, .button-secondary.ui-widget-header .button-secondary.ui-state-default { border: 1px solid #904c75; background: #750048 50% 50% repeat-x; font-weight: normal; color: #ffffff; }
            .button-secondary.ui-state-default a, .button-secondary.ui-state-default a:link, .button-secondary.ui-state-default a:visited { color: #ffffff; text-decoration: none; }
            .button-secondary.ui-state-hover, .button-secondary.ui-widget-content .button-secondary.ui-state-hover, .button-secondary.ui-widget-header .button-secondary.ui-state-hover, .button-secondary.ui-state-focus, .button-secondary.ui-widget-content .button-secondary.ui-state-focus, .button-secondary.ui-widget-header .button-secondary.ui-state-focus { border: 1px solid #904c75; background: #904c75 50% 50% repeat-x; font-weight: normal; color: #ffffff; }
            .button-secondary.ui-state-hover a, .button-secondary.ui-state-hover a:hover { color: #ffffff; text-decoration: none; }
            .button-secondary.ui-state-active, .button-secondary.ui-widget-content .button-secondary.ui-state-active, .button-secondary.ui-widget-header .button-secondary.ui-state-active { border: 1px solid #750048; background: #904c75 50% 50% repeat-x; font-weight: normal; color: #ffffff; }
            .button-secondary.ui-state-active a, .button-secondary.ui-state-active a:link, .button-secondary.ui-state-active a:visited { color: #ffffff; text-decoration: none; }
            .button-secondary.ui-widget :active { outline: none; }

        </style>        
        <script type="text/javascript" charset="utf-8">
            var transitions = [
                {1: [1, 4], 2: [2, 5, 8], 3: [3, 6, 9, 12], 4: [7, 10, 13], 5: [11, 14], 6: [15]},
                {1: [0, 2, 5], 2: [3, 4, 6, 9], 3: [7, 8, 10, 13], 4: [11, 12, 14], 5: [15], 6: []},
                {1: [1, 3, 6], 2: [0, 5, 7, 10], 3: [4, 9, 11, 14], 4: [8, 13, 15], 5: [12], 6: []},
                {1: [2, 7], 2: [1, 6, 11], 3: [0, 5, 10, 15], 4: [4, 9, 14], 5: [8, 13], 6: [12]},
                {1: [0, 5, 8], 2: [1, 6, 9, 12], 3: [2, 7, 10, 13], 4: [3, 11, 14], 5: [15], 6: []},
                {1: [1, 4, 6, 9], 2: [0, 2, 7, 8, 10, 13], 3: [3, 11, 12, 14], 4: [15], 5: [], 6: []},
                {1: [2, 5, 7, 10], 2: [1, 3, 4, 9, 11, 14], 3: [0, 8, 13, 15], 4: [12], 5: [], 6: []},
                {1: [3, 6, 11], 2: [2, 5, 10, 15], 3: [1, 4, 9, 14], 4: [0, 8, 13], 5: [12], 6: []},
                {1: [4, 9, 12], 2: [0, 5, 10, 13], 3: [1, 6, 11, 14], 4: [2, 7, 15], 5: [3], 6: []},
                {1: [5, 8, 10, 13], 2: [1, 4, 6, 11, 12, 14], 3: [0, 2, 7, 15], 4: [3], 5: [], 6: []},
                {1: [6, 9, 11, 14], 2: [2, 5, 7, 8, 13, 15], 3: [1, 3, 4, 12], 4: [0], 5: [], 6: []},
                {1: [7, 10, 15], 2: [3, 6, 9, 14], 3: [2, 5, 8, 13], 4: [1, 4, 12], 5: [0], 6: []},
                {1: [8, 13], 2: [4, 9, 14], 3: [0, 5, 10, 15], 4: [1, 6, 11], 5: [2, 7], 6: [3]},
                {1: [9, 12, 14], 2: [5, 8, 10, 15], 3: [1, 4, 6, 11], 4: [0, 2, 7], 5: [3], 6: []},
                {1: [10, 13, 15], 2: [6, 9, 11, 12], 3: [2, 5, 7, 8], 4: [1, 3, 4], 5: [0], 6: []},
                {1: [11, 14], 2: [7, 10, 13], 3: [3, 6, 9, 12], 4: [2, 5, 8], 5: [1, 4], 6: [0]}
            ];
            var cellWidth = 100,
                    diceSize = 80,
                    fontSize = 40,
                    boardSize = 4;
            var playersData = [
                {dices: 2, specials: {Transfert: 1, Inc: 1, Random: 1, Diago: 1}, game: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0], color: "#D60"},
                {dices: 3, specials: {Transfert: 1, Inc: 1, Random: 1, Diago: 1}, game: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0], color: "#2AF"}
            ];
	    var buttonsClasses = ["button-primary", "button-secondary"]
            // which player is playing now
            var playingNow = 0;
            var game = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

            function drawGame() {
		 game = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
		 var buttonClasses;
                for (var player = 0; player < 2; player++) {
		    // draw board
		    buttonClasses = buttonsClasses[player];
		    if (player == playingNow) {
		      buttonClasses += " board-dice-playing";
		    }
                    for (var i = 0; i < (boardSize * boardSize); i++) {
			 if (game[i] == 0) {
			    if (playersData[player].game[i] > 0) {
				game[i] = playersData[player].game[i];
				$("#board .cell-" + i).html('<div position="' + i + '" value="' + playersData[player].game[i] + '" player="' + player + '" class="board-dice-button ' + buttonClasses + '"><img class="dice-button-image" src="icons/dice' + playersData[player].game[i] + '.svg" width="100px" /></div>');
			    } else {
				$("#board .cell-" + i).empty();
			    }
                        }
                    }
                    // draw remaining dices
		    buttonClasses = buttonsClasses[player];
		    if (player == playingNow) {
		      buttonClasses += " remaining-dice-playing";
		    }
		    $("#player"+player).empty();
		    for (var i = 0; i < playersData[player].dices; i++) {
			$("#player"+player).append('<tr><td><div player="' + player + '" class="remaining-dice-button ' + buttonClasses + '"><img class="dice-button-image" src="icons/dice1.svg" width="100px" /></div></td></tr>')
		    }
                }
                $('.board-dice-button[player="' + playingNow + '"]').button();
                $('.remaining-dice-button[player="' + playingNow + '"]').button();
            }
            
            function nextPlayer() {
	      playingNow = playingNow?0:1;
	      drawGame();
            }
                        
            function initBoard() {
                // drawing cells
                var board = $("#board");
                for (var i = 0; i < boardSize; i++) {
                    var row = "<tr>";
                    for (var j = 0; j < boardSize; j++) {
                        row += '<td class="cell-' + (i * boardSize + j) + '"></td>';
                    }
                    board.append(row);
                }
                //$("#board td").css("width",0.9/boardSize+"%");

                drawGame();
                
                // adding event on dices
                $("#player0, #player1").on('click', '.remaining-dice-playing', function() {
                    $.each([0, 1, 2, 3, 4, 7, 8, 11, 12, 13, 14, 15], function(index, candidate) {
			//console.log(index, candidate)
			if (game[candidate]==0) {
			  $("#board .cell-" + candidate).append('<div position="' + candidate + '" " fromValue="1" class="board-candidate-button ' + buttonsClasses[playingNow] + '"><img class="dice-button-image" src="icons/dice0.svg" width="100px" /></div>');
                        $(".board-candidate-button").button();
			}
                    });
                });
                $("#board").on('click', '.board-dice-playing', function() {
                    var candidates = []
                    var pos = $(this).attr('position');
                    var value = $(this).attr('value');
                    var currentTransitions = transitions[pos];
                    for (var l = 1; l <= value; l++) {
                        var t = currentTransitions[l];
                        for (var i = 0; i < t.length; i++) {
                            if (game[t[i]] == 0) {
                                candidates.push(t[i]);
                            }
                        }
                    }
                    $.each(candidates, function(index, candidate) {
                        $("#board .cell-" + candidate).append('<div position="' + candidate + '" fromPosition="' + pos + '" fromValue="' + value + '" class="board-candidate-button ' + buttonsClasses[playingNow] + '"><img class="dice-button-image" src="icons/dice0.svg" width="100px" /></div>');
                        $(".board-candidate-button").button();
                    });
                    // TODO add an event on the selected dice for cancelling the move

                });
                $("#board").on('click', ".board-candidate-button", function() {
                    var pos = $(this).attr('position');
                    var fromPosition = $(this).attr('fromPosition');
                    if (typeof(fromPosition) == "undefined") {
			playersData[playingNow].dices--;
                    }
                    var value = $(this).attr('fromValue');
		     playersData[playingNow].game[fromPosition] = 0;
		     playersData[playingNow].game[pos] = value;
		     nextPlayer();
                });
                // TODO add the increment action
            }
            $(document).ready(function() {
                initBoard();
            });
        </script>
    </head>
    <body>
        <h1>4 à 2</h1>
        <table id="player0"></table>
        <table id="board"></table>
        <table id="player1"></table>
    </body>
</html>
